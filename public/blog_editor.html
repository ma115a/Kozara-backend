<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>KPR | Blog Editor</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.css" />
		<link rel="stylesheet" href="./css/jodit.min.css" />
		<link rel="stylesheet" href="./css/blog_editor.css" />
		<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/components/tab-group/tab-group.js"></script>
		<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/components/tab/tab.js"></script>
		<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/components/tab-panel/tab-panel.js"></script>
		<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/components/icon/icon.js"></script>
		<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/components/icon-button/icon-button.js"></script>
		<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/components/button/button.js"></script>
		<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/components/menu/menu.js"></script>
		<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/components/menu-item/menu-item.js"></script>
		<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/components/dropdown/dropdown.js"></script>
		<script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/components/button-group/button-group.js"></script>
		<script src="./js/jodit.min.js"></script>
	</head>
	<body>
		<sl-tab-group id="tabgroup">
			<sl-tab slot="nav" panel="all">All blogs</sl-tab>
			<sl-button slot="nav" onclick="new_blog()">
				New Blog
				<sl-icon slot="suffix" src="./assets/amenities_icons/file-plus-corner.svg"></sl-icon>
			</sl-button>

			<sl-tab-panel id="all_blogs_container" name="all"></sl-tab-panel>
		</sl-tab-group>
	</body>
	<script>
		let open_tabs = 0
		let editors = {}

		// close tab logic
		tabgroup.addEventListener("sl-close", async event => {
			const tab = event.target
			const panel = tabgroup.querySelector(`sl-tab-panel[name="${tab.panel}"]`)

			// Show the previous tab if the tab is currently active
			if (tab.active) {
				let tab2 = tab.nextElementSibling
				// try next
				while (tab2) {
					if (tab2.panel) break
					tab2 = tab2.nextElementSibling
				}
				// try previous
				if (!tab2) {
					tab2 = tab.previousElementSibling
					while (tab2) {
						if (tab2.panel) break
						tab2 = tab2.previousElementSibling
					}
				}
				tabgroup.show(tab2.panel)
			}

			tab.remove()
			panel.remove()
		})

		function new_blog() {
			open_tabs++
			const newtab = Object.assign(document.createElement("sl-tab"), {
				slot: "nav",
				panel: `newtab${open_tabs}`,
				closable: "true",
				innerHTML: `New blog`,
			})
			const newpanel = Object.assign(document.createElement("sl-tab-panel"), {
				name: `newtab${open_tabs}`,
				innerHTML: `
				<div class='buttons'>
					<sl-button-group label='Save or delete'>
						<sl-button variant='primary' onclick="save_blog('${newtab.panel}')">
							Save
							<sl-icon src="./assets/amenities_icons/save.svg" slot="prefix">
						</sl-button>
						<sl-button variant='danger'>
							Delete
							<sl-icon src="./assets/amenities_icons/trash-2.svg" slot="prefix">
						</sl-button>
					</sl-button-group>
				</div>
				<div class='doc_body'>
					<textarea class='editor'></textarea>
				</div>`,
			})
			tabgroup.appendChild(newtab)
			tabgroup.appendChild(newpanel)
			const editor_holder = newpanel.querySelector(".editor")
			editors[newtab.panel] = Jodit.make(newpanel.querySelector(".editor"), {
				toolbarAdaptive: false,
				uploader: {
					url: "http://localhost:5000/upload",
					method: "POST",
					format: "json",
					// filesVariableName: "file",
				},
			})
			setTimeout(() => {
				tabgroup.show(newtab.panel)
			}, 50)
		}

		function save_blog(panel_name) {
			const tab = document.querySelector(`sl-tab[panel="${panel_name}"]`)
			const panel = document.querySelector(`sl-tab-panel[name="${panel_name}"]`)
			const blogid = panel.dataset.blogid || null

			let title_img = null
			try {
				title_img = /<img.*?src="(.*?)".*?>/.exec(editors[panel_name].value)[1]
			} catch (error) {}

			let title = "Untitled"
			const contentchildren = panel.querySelector(".jodit-wysiwyg").children
			for (let index = 0; index < contentchildren.length; index++) {
				let txt = contentchildren[index].textContent || contentchildren[index].innerText || ""
				txt = txt.replaceAll(/\r?\n/g, "")
				if (txt.length > 0) {
					title = txt
					break
				}
			}

			tab.innerHTML = title
			console.log(
				JSON.stringify({
					title,
					title_img,
					editor: editors[panel_name].value,
					blogid,
				})
			)
			fetch("http://localhost:5000/saveblog", {
				method: "POST",
				headers: { "Content-type": "application/json" },
				body: JSON.stringify({
					title,
					title_img,
					editor: editors[panel_name].value,
					blogid,
				}),
			})
				.then(res => res.json())
				.then(res => {
					if (!res.success) {
						alert("Save failed")
						return
					}
					alert("Save success")
					if (!blogid) {
						panel.dataset.blogid = res.blogid
						// TODO: Add to All Blogs if it didn't exist before
					}
				})
		}

		const all_blogs = JSON.parse(localStorage.getItem("saved_blog"))
		function load_all_blogs() {
			// implement bulk processing
			// all_blogs.forEach ...
			const newblog = Object.assign(document.createElement("div"), {
				className: "blog_block",
				innerHTML: `
				<div class='title'>
					${all_blogs.title}
				</div>`,
			})
			newblog.dataset.blogid = all_blogs.blogid
			newblog.style.backgroundImage = `url(${all_blogs.title_img})`
			newblog.setAttribute("onclick", `open_blog(${all_blogs.blogid})`)
			all_blogs_container.appendChild(newblog)
		}
		load_all_blogs()

		function open_blog(id) {
			open_tabs++
			const newtab = Object.assign(document.createElement("sl-tab"), {
				slot: "nav",
				panel: `${all_blogs.blogid}`,
				closable: "true",
				innerHTML: all_blogs.title,
			})
			const newpanel = Object.assign(document.createElement("sl-tab-panel"), {
				name: `${all_blogs.blogid}`,
				innerHTML: `
				<div class='buttons'>
					<sl-button-group label='Save or delete'>
						<sl-button variant='primary' onclick="save_blog('${newtab.panel}')">
							Save
							<sl-icon src="./assets/amenities_icons/save.svg" slot="prefix">
						</sl-button>
						<sl-button variant='danger'>
							Delete
							<sl-icon src="./assets/amenities_icons/trash-2.svg" slot="prefix">
						</sl-button>
					</sl-button-group>
				</div>
				<div class='doc_body'>
					<textarea class='editor'></textarea>
				</div>`,
			})
			tabgroup.appendChild(newtab)
			tabgroup.appendChild(newpanel)
			const editor_holder = newpanel.querySelector(".editor")
			editors[newtab.panel] = Jodit.make(newpanel.querySelector(".editor"), {
				toolbarAdaptive: false,
				uploader: {
					url: "http://localhost:5000/upload",
					method: "POST",
					format: "json",
					// filesVariableName: "file",
				},
			})
			editors[newtab.panel].value = all_blogs.editor
			setTimeout(() => {
				tabgroup.show(newtab.panel)
			}, 50)
		}

		function delete_blog(panel_name) {}
	</script>
</html>
